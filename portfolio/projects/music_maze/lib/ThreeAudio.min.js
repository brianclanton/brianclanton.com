var MicroEvent=function(){};MicroEvent.prototype={bind:function(a,c){this._events=this._events||{};this._events[a]=this._events[a]||[];this._events[a].push(c)},unbind:function(a,c){this._events=this._events||{};!1!==a in this._events&&this._events[a].splice(this._events[a].indexOf(c),1)},trigger:function(a){this._events=this._events||{};if(!1!==a in this._events)for(var c=0;c<this._events[a].length;c++)this._events[a][c].apply(this,Array.prototype.slice.call(arguments,1))}};
MicroEvent.mixin=function(a){for(var c=["bind","unbind","trigger"],j=0;j<c.length;j++)a.prototype[c[j]]=MicroEvent.prototype[c[j]]};"undefined"!==typeof module&&"exports"in module&&(module.exports=MicroEvent);var DSP={LEFT:0,RIGHT:1,MIX:2,SINE:1,TRIANGLE:2,SAW:3,SQUARE:4,LOWPASS:0,HIGHPASS:1,BANDPASS:2,NOTCH:3,BARTLETT:1,BARTLETTHANN:2,BLACKMAN:3,COSINE:4,GAUSS:5,HAMMING:6,HANN:7,LANCZOS:8,RECTANGULAR:9,TRIANGULAR:10,OFF:0,FW:1,BW:2,FWBW:3,TWO_PI:2*Math.PI};
function FourierTransform(a,c){this.bufferSize=a;this.sampleRate=c;this.bandwidth=2/a*c/2;this.spectrum=new Float32Array(a/2);this.real=new Float32Array(a);this.imag=new Float32Array(a);this.peak=this.peakBand=0;this.getBandFrequency=function(a){return this.bandwidth*a+this.bandwidth/2};this.calculateSpectrum=function(){for(var c=this.spectrum,d=this.real,e=this.imag,h=2/this.bufferSize,f=Math.sqrt,k,m,n=0,q=a/2;n<q;n++)k=d[n],m=e[n],k=h*f(k*k+m*m),k>this.peak&&(this.peakBand=n,this.peak=k),c[n]=
k}}function DFT(a,c){FourierTransform.call(this,a,c);var j=a/2*a,d=2*Math.PI;this.sinTable=new Float32Array(j);this.cosTable=new Float32Array(j);for(var e=0;e<j;e++)this.sinTable[e]=Math.sin(e*d/a),this.cosTable[e]=Math.cos(e*d/a)}DFT.prototype.forward=function(a){for(var c=this.real,j=this.imag,d,e,h=0;h<this.bufferSize/2;h++){for(var f=e=d=0;f<a.length;f++)d+=this.cosTable[h*f]*a[f],e+=this.sinTable[h*f]*a[f];c[h]=d;j[h]=e}return this.calculateSpectrum()};
function FFT(a,c){FourierTransform.call(this,a,c);this.reverseTable=new Uint32Array(a);for(var j=1,d=a>>1,e;j<a;){for(e=0;e<j;e++)this.reverseTable[e+j]=this.reverseTable[e]+d;j<<=1;d>>=1}this.sinTable=new Float32Array(a);this.cosTable=new Float32Array(a);for(e=0;e<a;e++)this.sinTable[e]=Math.sin(-Math.PI/e),this.cosTable[e]=Math.cos(-Math.PI/e)}
FFT.prototype.forward=function(a){var c=this.bufferSize,j=this.cosTable,d=this.sinTable,e=this.reverseTable,h=this.real,f=this.imag,k=Math.floor(Math.log(c)/Math.LN2);if(Math.pow(2,k)!==c)throw"Invalid buffer size, must be a power of 2.";if(c!==a.length)throw"Supplied buffer is not the same size as defined FFT. FFT Size: "+c+" Buffer Size: "+a.length;var k=1,m,n,q,p,t,g;for(g=0;g<c;g++)h[g]=a[e[g]],f[g]=0;for(;k<c;){a=j[k];e=d[k];m=1;for(var r=n=0;r<k;r++){for(g=r;g<c;)q=g+k,p=m*h[q]-n*f[q],t=m*f[q]+
n*h[q],h[q]=h[g]-p,f[q]=f[g]-t,h[g]+=p,f[g]+=t,g+=k<<1;g=m;m=g*a-n*e;n=g*e+n*a}k<<=1}return this.calculateSpectrum()};
FFT.prototype.inverse=function(a,c){var j=this.bufferSize,d=this.cosTable,e=this.sinTable,h=this.reverseTable,a=a||this.real,c=c||this.imag,f=1,k,m,n,q,p,t,g;for(g=0;g<j;g++)c[g]*=-1;k=new Float32Array(j);m=new Float32Array(j);for(g=0;g<a.length;g++)k[g]=a[h[g]],m[g]=c[h[g]];a=k;for(c=m;f<j;){h=d[f];k=e[f];m=1;for(var r=n=0;r<f;r++){for(g=r;g<j;)q=g+f,p=m*a[q]-n*c[q],t=m*c[q]+n*a[q],a[q]=a[g]-p,c[q]=c[g]-t,a[g]+=p,c[g]+=t,g+=f<<1;g=m;m=g*h-n*k;n=g*k+n*h}f<<=1}d=new Float32Array(j);for(g=0;g<j;g++)d[g]=
a[g]/j;return d};
function RFFT(a,c){FourierTransform.call(this,a,c);this.trans=new Float32Array(a);this.reverseTable=new Uint32Array(a);this.reverseBinPermute=function(a,c){var e=this.bufferSize,h=e>>>1,e=e-1,f=1,k=0,m;a[0]=c[0];do{k+=h;a[f]=c[k];a[k]=c[f];f++;for(m=h<<1;m>>=1,!((k^=m)&m););k>=f&&(a[f]=c[k],a[k]=c[f],a[e-f]=c[e-k],a[e-k]=c[e-f]);f++}while(f<h);a[e]=c[e]};this.generateReverseTable=function(){var a=this.bufferSize,c=a>>>1,a=a-1,e=1,h=0,f;this.reverseTable[0]=0;do{h+=c;this.reverseTable[e]=h;this.reverseTable[h]=
e;e++;for(f=c<<1;f>>=1,!((h^=f)&f););h>=e&&(this.reverseTable[e]=h,this.reverseTable[h]=e,this.reverseTable[a-e]=a-h,this.reverseTable[a-h]=a-e);e++}while(e<c);this.reverseTable[a]=a};this.generateReverseTable()}
RFFT.prototype.forward=function(a){var c=this.bufferSize,j=this.spectrum,d=this.trans,e=2*Math.PI,h=Math.sqrt,f=c>>>1,k=2/c,m,n,q,p,t,g,r,s,x,v,u,C,D,E,G,z,A,B,H,I,J;this.reverseBinPermute(d,a);p=0;for(var y=4;p<c;y*=4){for(var w=p;w<c;w+=y)z=d[w]-d[w+1],d[w]+=d[w+1],d[w+1]=z;p=2*(y-1)}a=2;for(q=c>>>1;q>>>=1;){p=0;a<<=1;y=a<<1;m=a>>>2;n=a>>>3;do{if(1!==m)for(w=p;w<c;w+=y)s=w,x=s+m,v=x+m,u=v+m,p=d[v]+d[u],d[u]-=d[v],d[v]=d[s]-p,d[s]+=p,s+=n,x+=n,v+=n,u+=n,p=d[v]+d[u],t=d[v]-d[u],p=-p*Math.SQRT1_2,
t*=Math.SQRT1_2,z=d[x],d[u]=p+z,d[v]=p-z,d[x]=d[s]-t,d[s]+=t;else for(w=p;w<c;w+=y)s=w,x=s+m,v=x+m,u=v+m,p=d[v]+d[u],d[u]-=d[v],d[v]=d[s]-p,d[s]+=p;p=(y<<1)-a;y<<=2}while(p<c);J=e/a;for(var F=1;F<n;F++){A=F*J;B=Math.sin(A);A=Math.cos(A);H=4*A*(A*A-0.75);I=4*B*(0.75-B*B);p=0;y=a<<1;do{for(w=p;w<c;w+=y)s=w+F,x=s+m,v=x+m,u=v+m,C=w+m-F,D=C+m,E=D+m,G=E+m,t=d[E]*A-d[v]*B,p=d[E]*B+d[v]*A,r=d[G]*H-d[u]*I,g=d[G]*I+d[u]*H,z=t-r,t+=r,r=z,d[G]=t+d[D],d[v]=t-d[D],z=g-p,p+=g,g=z,d[u]=g+d[x],d[E]=g-d[x],d[D]=d[s]-
p,d[s]+=p,d[x]=r+d[C],d[C]-=r;p=(y<<1)-a;y<<=2}while(p<c)}}for(;--f;)e=d[f],a=d[c-f-1],e=k*h(e*e+a*a),e>this.peak&&(this.peakBand=f,this.peak=e),j[f]=e;j[0]=k*d[0];return j};(function(a){for(i in a)if(!window[i])throw"Error: ThreeAudio requires "+a[i];})({THREE:"Three.js",MicroEvent:"MicroEvent.js"});window.ThreeAudio=window.ThreeAudio||{};ThreeAudio.getShader=function(a){var c=document.getElementById(a);return c&&c.innerText||a};window._=window._||{};
_.each=_.each||function(a,c){if(a.forEach)return a.forEach(c);for(key in a)c(a[key],key,a)};_.extend=_.extend||function(a){_.each([].slice.call(arguments,1),function(c){for(var j in c)a[j]=c[j]});return a};MicroEvent.prototype.on=function(){MicroEvent.prototype.bind.apply(this,arguments);return this};MicroEvent.prototype.emit=function(){MicroEvent.prototype.trigger.apply(this,arguments);return this};
MicroEvent.mixin=function(a){for(var c=["bind","unbind","trigger","on","emit"],j=0;j<c.length;j++)a.prototype[c[j]]=MicroEvent.prototype[c[j]]};ThreeAudio.toTexture=function(a){return ThreeRTT&&ThreeRTT.toTexture&&ThreeRTT.toTexture(a)||a};var \u03c0=Math.PI,\u03c4=2*\u03c0;ThreeAudio.Source=function(a){this.fftSize=a||1024;this.filters={};this.playing=!1;this.init()};
ThreeAudio.Source.prototype={init:function(){var a=this.context=new webkitAudioContext;this.source=a.createBufferSource();this.analyser=a.createAnalyser();var c=this.analyser.fftSize=this.fftSize,j=this.filters;_.each({bass:{type:0,frequency:160,Q:1.2,gain:2},mid:{type:2,frequency:500,Q:1.2,gain:4},treble:{type:1,frequency:2E3,Q:1.2,gain:3}},function(d,h){var f=a.createBiquadFilter();f.key=h;f.type=d.type;f.frequency.value=d.frequency;f.Q.value=d.Q;f.analyser=a.createAnalyser();f.analyser.fftSize=
c;f.delayNode=a.createDelayNode();f.delayNode.delayTime.value=0;f.gainNode=a.createGainNode();f.gainNode.gain.value=d.gain;j[h]=f});this.delay=a.createDelayNode();this.delay.delayTime.value=2*this.fftSize/a.sampleRate;this.source.connect(this.analyser);this.analyser.connect(this.delay);this.delay.connect(a.destination);var d=this.source;_.each(j,function(a){d.connect(a.delayNode);a.delayNode.connect(a);a.connect(a.gainNode);a.gainNode.connect(a.analyser)});this.samples=this.analyser.frequencyBinCount;
this.data={freq:new Uint8Array(this.samples),time:new Uint8Array(this.samples),filter:{bass:new Uint8Array(this.samples),mid:new Uint8Array(this.samples),treble:new Uint8Array(this.samples)}};this.levelDetect=new ThreeAudio.LevelDetect(this.data);this.beatDetect=new ThreeAudio.BeatDetect(this.data)},update:function(){var a=this.analyser,c=this.data;a.smoothingTimeConstant=0;a.getByteFrequencyData(c.freq);a.getByteTimeDomainData(c.time);_.each(this.filters,function(a){a.analyser.getByteTimeDomainData(c.filter[a.key])});
this.levelDetect.analyse();this.beatDetect.analyse();return this},size:function(){return this.analyser.frequencyBinCount},load:function(a,c){var j=this.context,d=this.source,e=this,h=new XMLHttpRequest;h.open("GET",a,!0);h.responseType="arraybuffer";h.onload=function(){var a=j.createBuffer(h.response,!1);d.buffer=a;d.loop=!0;e.playing&&e._play();c&&c()};h.send();return this},play:function(){this.playing=!0;this.source.buffer&&this._play();return this},stop:function(){this.playing=!1;this.source.buffer&&
this._stop();return this},_play:function(){this.source.noteOn(0)},_stop:function(){this.source.noteOff(0)}};ThreeAudio.Source.prototype.start=ThreeAudio.Source.prototype.play;
ThreeAudio.Material=function(a,c,j,d,e,h){var h=h||[],e=_.extend(e||{},{audioIsBeat:{type:"f",value:0},audioWasBeat:{type:"f",value:0},audioLevels:{type:"fv1",value:[0,0,0,0]},audioLevelsSmooth:{type:"fv1",value:[0,0,0,0]},audioLevelsChange:{type:"fv1",value:[0,0,0,0]},audioOffset:{type:"f",value:0},audioStep:{type:"v2",value:{x:0,y:0}}}),f=0;_.each(a.get(),function(a,c){var d=new THREE.Texture(new Image,new THREE.UVMapping,THREE.ClampToEdgeWrapping,THREE.RepeatWrapping,THREE.NearestFilter,THREE.NearestFilter);
d.__webglInit=!0;d.__webglTexture=a;e[c+"Data"]={type:"t",texture:d,value:f++}});_.each(d||[],function(a,c){e[c]={type:"t",value:f++,texture:ThreeAudio.toTexture(a)}});a.on("update",function(a){_.each(a,function(a,c){e[c].value=a})});return new THREE.ShaderMaterial({attributes:h,uniforms:e,vertexShader:ThreeAudio.getShader(c),fragmentShader:ThreeAudio.getShader(j)})};
ThreeAudio.Textures=function(a,c,j){this.renderer=a;this.source=c;this.textures={};this.history=j||128;this.timeIndex=0;this.data=c.data;this.init()};
ThreeAudio.Textures.prototype={init:function(){var a=this.renderer,c=a.getContext(),j=this.textures,d=this.data,e=this.history,h,f,k;_.each(["freq","time"],function(m){j[m]&&(c.deleteTexture(j[m]),a.info.memory.textures--);h=j[m]=c.createTexture();a.info.memory.textures++;c.bindTexture(c.TEXTURE_2D,h);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,c.REPEAT);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.LINEAR);c.texParameteri(c.TEXTURE_2D,
c.TEXTURE_MAG_FILTER,c.LINEAR);f=d[m];k=new Uint8Array(f.length*e);if("time"==m)for(m=0;m<f.length*e;++m)k[m]=128;c.texImage2D(c.TEXTURE_2D,0,c.ALPHA,f.length,e,0,c.ALPHA,c.UNSIGNED_BYTE,k)})},update:function(){var a=this.renderer.getContext(),c=this.textures,j=this.source,d=this.history,e=this.timeIndex,h=j.data;j.update();_.each(["freq","time"],function(d){a.bindTexture(a.TEXTURE_2D,c[d]);a.pixelStorei(a.UNPACK_ALIGNMENT,1);a.texSubImage2D(a.TEXTURE_2D,0,0,e,h[d].length,1,a.ALPHA,a.UNSIGNED_BYTE,
h[d])});this.emit("update",this.uniforms());this.timeIndex=(e+1)%d},get:function(){return this.textures},uniforms:function(){var a=this.data.levels,c=this.data.beat;return{audioIsBeat:c.is,audioWasBeat:c.was,audioLevels:a.direct,audioLevelsSmooth:a.smooth,audioLevelsChange:a.change,audioOffset:this.timeIndex/this.history,audioStep:{x:1/(this.source.samples-1),y:1/this.history}}}};MicroEvent.mixin(ThreeAudio.Textures);
ThreeAudio.GridGeometry=function(a,c,j,d,e){var h=a.source,d=(d||h.samples)-1,e=Math.min(a.history,e||a.history)-1,f=e/a.history,k=0.5/(h.samples-1);offsetV=0.5/a.history;a=new THREE.PlaneGeometry(c,j,d,e);_.each(a.faceVertexUvs[0],function(a){_.each(a,function(a){a.u+=k;a.v=1-a.v*f+offsetV})});return a};ThreeAudio.LevelDetect=function(a){this.data=a;this.levels=[[0,0,0,0]];this.smooth=[0,0,0,0];this.change=[0,0,0,0];a.levels={direct:this.levels[0],smooth:this.smooth,change:this.change}};
ThreeAudio.LevelDetect.prototype.analyse=function(){for(var a=this.data,c=this.levels,j=this.smooth,d=this.change,e=[0,0,0,0],h=[a.time,a.filter.bass,a.filter.mid,a.filter.treble],a=0;4>a;++a){var f=e,k=a,m;m=h[a];for(var n=m.length,q=0,p=0;p<n;++p)var t=(m[p]-128)/128,q=q+t*t;m=Math.sqrt(q/n);f[k]=m}c.unshift(e);7<c.length&&c.pop();h=[1,2,1];f=4;k=Math.min(c.length,h.length);for(m=0;4>m;++m){for(a=e=0;a<k;++a)e+=(c[a]&&c[a][m]||0)*h[a];j[m]=e/f}h=[1,3,2,-2,-3,-1];f=6;Math.min(c.length,h.length);
for(m=0;4>m;++m){for(a=e=0;a<k;++a)e+=(c[a]&&c[a][m]||0)*h[a];d[m]+=0.5*(e/f-d[m])}this.data.levels.direct=this.levels[0]};var __taDebug=!1;
ThreeAudio.BeatDetect=function(a){this.data=a;a.beat={permanence:0,confidence:0,missed:!1,predicted:!1,maybe:!1,is:!1,was:0,stddev:0,bpm:0};__taDebug&&this.initDebug();this.n=512;this.history=[[],[],[]];this.buffer=new Float32Array(this.n);this.spectrum=null;this.fft=new FFT(this.n,44100);this.decay=this.debouncePredict=this.debounceMaybe=this.maxMaybe=this.maybe=this.measure=this.signal=this.energy=this.background=this.sample=0;this.intervals=[];this.jitter=this.stddev=this.mean=0;this.missed=3;
this.found=0;this.predicted=!1;this.green=0;this.fMin=Math.floor(this.bpmToOffset(50));this.fMax=Math.ceil(this.bpmToOffset(400));this.histogram={};this.histogramSorted=[];this.beat=null;this.frames=0};
ThreeAudio.BeatDetect.prototype={initDebug:function(){this.c=document.createElement("canvas");this.c.width=512;this.c.height=340;this.c.style.position="absolute";this.c.style.zIndex=20;this.c.style.marginTop="100px";this.g=this.c.getContext("2d");this.i=0;this.t=document.createElement("div");this.t.width=256;this.t.height=200;this.t.style.background="rgba(0,0,0,.3)";this.t.style.color="#fff";this.t.style.position="absolute";this.t.style.zIndex=20;this.t.style.marginTop="340px";document.body.appendChild(this.c);
document.body.appendChild(this.t)},bpmToOffset:function(a){return this.n*a/3600},offsetToBPM:function(a){return 3600*a/this.n},analyse:function(){var a=this.data,c=a.levels,j=this.buffer,d=this.fft,e=this.n,h=this.history,f=this.histogram,k=this.histogramSorted,m=this;a.beat.missed=!1;a.beat.maybe=!1;a.beat.is=!1;a.beat.predicted=!1;a.beat.locked=!1;a.beat.adjusted=!1;this.beat&&(a.beat.confidence=this.beat.confidence,a.beat.permanence=this.beat.permanence,a.beat.bpm=this.beat.bpm);var n=c.direct[0];
this.background+=0.2*(n-this.background);this.energy+=0.4*(n-this.energy);this.signal=n=3*((this.energy-this.background)/(1-this.background));c=this.maybe;maybe=2*n-this.signal;this.maxMaybe=Math.max(0.99*this.maxMaybe,maybe);this.maybe=maybe=maybe/Math.max(0.2,this.maxMaybe)-0.7;this.sample=n;for(h.unshift(n);h.length>e;)h.pop();j.set(h);d.forward(j);for(var q=this.spectrum=d.real,n=d.real,j=d.imag,d=0;d<e;++d)q[d]=n[d]*n[d]+j[d]*j[d];j=0;for(d=2;d<e/8;++d)j=Math.max(j,q[d]);for(var h={},p=j/16,
d=this.fMin+1;d<this.fMax;++d)if(n=q[d],n>p){var t=Math.max(q[d-1],q[d+1]);if(n>t&&(t=Math.min(q[d-1],q[d+1]),0.5<Math.abs(n-t)/n)){var g=Math.sqrt(n/j);h[d]=g}}_.each(k,function(a){a.permanence*=0.99;decay=Math.min(1,Math.log(1+a.permanence)/Math.log(10));a.strength*=decay;a.active=!1});_.each(h,function(a,c){var c=+c,d=q[c-1],g=q[c+1],h=d+g-2*q[c];b=(g-d)/2;fraction=-b/h;d=f[c];d||((d=f[c+1])?(delete f[c+1],d.index=c,d.fraction+=1,f[c]=d):(d=f[c-1])?(delete f[c-1],d.index=c,d.fraction-=1,f[c]=d):
(d=f[c]={index:c,fraction:fraction,offset:0,strength:0,permanence:0,score:0,window:0},k.push(d)));d.fraction+=0.1*(fraction-d.fraction);d.strength=a;d.permanence+=0.01*d.strength;d.offset=d.index+d.fraction;d.bpm=m.offsetToBPM(d.offset);d.window=e/d.offset;d.active=!0});k.sort(function(a,c){return c.permanence-a.permanence});for(var r;(r=k[k.length-1])&&0.01>r.strength;)k.splice(k.length-1,1),delete f[r.index];var s=this.fMin,x=0,v=0,u=null;_.each(k,function(a){var c=0;if(!(a.offset<s)){var d,e=0,
f=1.5*a.offset;_.each(k,function(c){if(c!=a&&!(c.offset<f)){var d=c.offset/a.offset,h=Math.max(0,1-4*Math.abs(d-Math.round(d)));g=c.strength*c.permanence*d;e+=h*g}});d=e;d>c&&(c=d);c+=a.strength*a.permanence;a.score=c;c>x?(u=a,v=x,x=c):c>v&&(v=c)}});u&&(u.score=x?1-v/x:0,u.confidence=Math.min(1,u.score+u.permanence),this.beat?this.beat.confidence<u.confidence?this.beat=u:this.beat!=u&&(this.beat.confidence*=0.95):this.beat=u,240<this.beat.bpm&&(this.beat.bpm/=2,this.beat.window*=2));r=this.measure;
d=0;this.beat&&(d=this.beat.window,this.mean&&2>this.stddev&&(d=this.mean,a.beat.locked=!0,a.beat.bpm=this.offsetToBPM(this.n/d)));0<maybe&&(0>=c&&5<this.debounceMaybe)&&(this.debounceMaybe=0,!this.beat||!a.beat.locked&&0.3>this.beat.confidence?(this.measure=0,a.beat.is=!0,a.beat.maybe=!0):this.beat&&(c=this.beat.window/2,c=(this.measure+c)%d-c,n=this.jitter&&Math.max(3,Math.min(this.jitter+1,10))||10,Math.abs(c)<n?(this.measure=0,1>=c&&5<this.debouncePredict||!this.predicted?(a.beat.is=!0,0<=c&&
(a.beat.predicted=!0),this.debouncePredict=0,this.found=Math.min(10,this.found+1),a.beat.adjusted=!0):(a.beat.maybe=!0,this.intervals[0]+=c,this.found=Math.min(10,this.found+1),this.missed=Math.max(0,this.missed-1)),this.found=Math.min(10,this.found+1),this.missed=Math.max(0,this.missed-3)):maybe>1+0.2*this.found+0.5/this.stddev-this.missed/10||0==this.found||4<this.missed?(this.measure=0,a.beat.is=!0,this.debouncePredict=0,this.found=Math.min(10,this.found+1),this.missed=Math.max(0,this.missed-3)):
a.beat.maybe=!0));if(this.beat&&0.3<this.beat.confidence){c=5<this.debouncePredict;if(n=this.measure>=d)this.measure-=d;n&&c&&(0>maybe?(this.found=Math.max(0,this.found-1),this.missed=Math.min(10,this.missed+1),a.beat.missed=!0,a.beat.predicted=!0):(this.found=Math.min(10,this.found+1),this.missed=Math.max(0,this.missed-3)),1>this.found?(n=!1,a.beat.maybe=!0,a.beat.predicted=!0,this.debouncePredict=0):4<this.missed&&(n=!1,a.beat.maybe=!0,a.beat.predicted=!0,this.measure+=5*Math.random(),this.debounceMaybe+=
5*Math.random(),this.debouncePredict=0),this.predicted=n);n&&c&&(this.debouncePredict=0,a.beat.is=!0,a.beat.predicted=!0)}c=0;if(3<this.missed)this.green=0;else if(a.beat.is||a.beat.adjusted)this.green++&&(c=this.frames-this.lastGreen),this.lastGreen=this.frames;if(c&&(c=this.intervals,c.unshift(r),12<c.length&&c.pop(),c=c.slice(),c.sort(),c=c.slice(2,10),2<c.length)){n=r=0;l=c.length;for(d=0;d<l;++d)r+=c[d],n+=c[d]*c[d];r/=l;n/=l;this.mean=r;this.stddev=Math.sqrt(n-r*r)}this.jitter=this.stddev*(1+
this.missed);this.decay+=0.4*(2.5*+a.beat.is-this.decay);a.beat.was+=0.4*(2.5*this.decay-a.beat.was);this.debounceMaybe++;this.debouncePredict++;this.measure++;this.frames++;__taDebug&&this.debug()},debug:function(){function a(a){a=Math.round(Math.max(0,Math.min(255,255*a)));g.fillStyle="rgb("+[a,a,a].join()+")";g.fillRect(s,x,1,20);x+=20}var c=this.data.levels.direct,j=this.sample,d=this.signal,e=this.maybe,h=this.spectrum,f=this.histogram,k=this.data.beat,m=this,n=this.n;if(this.beat){var q=this.beat,
p=1.5*q.offset;_.each(f,function(a){var c=a==q?1:0;a.offset>p&&(c=a.offset/q.offset,c=Math.max(0,1-4*Math.abs(c-Math.round(c))));a.match=c})}var t=["<strong><span"+(k.locked?' style="color: rgb(180,255,0)"':"")+">"+Math.round(10*k.bpm)/10+" BPM </span> ("+Math.round(100*k.confidence)+"%) P:"+Math.round(100*k.permanence)+" \u00b5 = "+Math.round(10*this.mean)/10+" \u03c3 = "+Math.round(100*this.stddev)/100+"</strong> "+this.found+"f "+this.missed+"m"];_.each(f,function(a){var c=Math.round(10*m.offsetToBPM(a.offset))/
10;t.push([c," bpm - ",Math.round(100*a.strength),"% P: ",Math.round(100*a.permanence)].join(""))});this.t.innerHTML=t.join("<br>");var g=this.g;g.fillStyle="#000000";g.fillRect(0,140,512,100);for(var r=0,s=2;s<n/8;++s)r=Math.max(h[s],r);r=1/r;g.beginPath();g.moveTo(0,200);for(s=2;s<n/8;++s)g.lineTo(8*(s-2),240-100*h[s]*r);g.strokeStyle="#ffffff";g.stroke();_.each(f,function(a){var c=0.75*a.strength+0.25,d=a.active?[Math.round(255-195*a.match),Math.round(180+40*a.match),0].join():"255,10,10";g.fillStyle=
"rgba("+d+","+c+")";g.fillRect(8*(a.offset-2),140,1,100)});var s=this.i,x=0;a(c[1]);a(c[2]);a(c[3]);a(0);k.is&&(g.fillStyle=k.missed?"rgba(255,0,0,.5)":k.maybe?"rgba(0,180,255,.75)":k.predicted?"rgba(255,180,0,.75)":"rgba(60,220,0,.75)",g.fillRect(this.i,0,2,100));c=Math.round(Math.max(0,Math.min(255,255*k.was)));g.fillStyle="rgb("+c+","+c+","+c+")";g.fillRect(412,240,100,100);k.maybe&&!k.is&&(g.fillStyle="rgba(64,64,64,.75)",g.fillRect(this.i,0,2,100));j=Math.floor(255*Math.max(0,Math.min(1,j+0.5)));
g.fillStyle="rgba("+Math.round(0.7*j)+","+Math.round(0.8*j)+","+j+",1)";g.fillRect(this.i,80,1,20);d=Math.floor(255*Math.max(0,Math.min(1,2*d)));g.fillStyle="rgba("+d+","+Math.round(0.8*d)+","+Math.round(0.5*d)+",1)";g.fillRect(this.i,100,1,20);e=k.is||k.maybe?Math.floor(255*Math.max(0,Math.min(1,e+0.5))):0;g.fillStyle="rgba("+Math.round(0.9*e)+","+e+","+Math.round(0.5*e)+",1)";g.fillRect(this.i,120,1,20);this.i=(s+1)%512}};
